name: Validate YAML
run-name: Checks for secrets, lints, and diffs YAML
on:
- push
jobs:
  Secret-Scanning:
    runs-on: k3s-pi-5-runner
    container:
      image: harbor.glythium.io/dockerhub/trufflesecurity/trufflehog:latest
    steps:
      - name: Check out repository code
        run: |
          git clone -b ${{ github.ref_name }} "${{ github.server_url }}/${{ github.repository }}" ${{ github.repository }}
      - name: Scan for plaintext secrets
        run: |
          trufflehog git file://. --since-commit main --branch ${{ github.ref_name }} --fail
          trufflehog filesystem . --only-verified --fail
  
  Validate-YAML-Syntax:
    needs:
    - Secret-Scanning
    runs-on: k3s-pi-5-runner
    container:
      image: harbor.glythium.io/custom/kubectl:latest
    steps:
      - name: Check out repository code
        run: |
          git clone -b ${{ github.ref_name }} "${{ github.server_url }}/${{ github.repository }}" ${{ github.repository }}
      - name: Validate YAML Syntax
        run: |
          cd ${{ github.repository }}
          for folder in "common services"; do
            for yaml in $(find "${folder}" -name *.yaml); do
              kubectl apply -f "${yaml}" --dry-run=server;
            done
          done
        continue-on-error: true
      - name: Diff YAML Files
        run: |
          cd ${{ github.repository }}
          for folder in "common services"; do
            for yaml in $(find ${folder} -name *.yaml | grep -v "template"); do
              kubectl diff -f "${yaml}" || status=$?;
              if [ ! -z $status ] && [ $status -gt 1 ]; then
                  exit $status;
              fi;
            done
          done
        continue-on-error: false
